<p>【JavaScript】サイドバーをスクロールで固定・解除するコード【解説付き】</p>
<h2 id="-">やりたいこと</h2>
<p>ページがスクロールされたら一定の位置でサイドバーを固定表示にし、スクロールされてもずっと残るようにして、更にページの一番下まで行ったら固定を解除する<br>という事をJavaScriptを使って実現したいと思います！</p>
<p>今回は2カラムレイアウトの場合を想定し、右側にサイドバーを作ってそれを固定&amp;解除したいと思います。<br>更に追加でページ幅が変わった場合も崩れないようにします。</p>
<h2 id="-">サンプル</h2>
<p>ページ幅1000px以上でサイドバーが表示されます。</p>
<p>()[]</p>
<h2 id="-">コード</h2>
<p>固定するだけならもっと短いコード量でいけるのですが、下部まで行ったら解除するのと、レスポンシブへの対応を追加したら少し冗長というか複雑な感じになってしまいました。</p>
<p>注意：jsファイルを分ける場合はリンクをbodyの最後に書くか、deferを付けて読み込んでください。</p>

<h3>HTML</h3>
<marquee>[<header id="header">
  <h1>ヘッダー</h1>
</header>


<div id="wrap">
  <main>
    <h1>メインコンテンツ</h1>
    <p>article...</p>
  </main>

  <aside class="right-bar">
    <h2>サイドバー</h2>
    <div class="aside-box">
      <p>text</p>
    </div>
    <div class="aside-box">
      <p>Ad</p>
    </div>
  </aside>
</div>

<footer>
  <h1>フッター</h1>
</footer>

]</marquee>

<h3>CSS</h3>
<marquee>[header {
  max-width: 980px;
  height: 300px;
  margin: auto;
  border: 1px solid black;
  text-align: center;
}

#wrap {
  display: flex;
  /* 下に回り込む設定 */
  flex-wrap: wrap;　
  /* flexboxの要素をセンターに寄せる */
  justify-content: center;
  margin: auto;
  max-width: 980px;
  height: auto;
  border: 1px solid black;
}

main {
  width: 75%;
  height: 2000px;
  text-align: center;
  background-color: #BAD3FF;
}

.right-bar {
  position: absolute;
  width: 245px;
  text-align: center;
  background-color: #75A9FF;
  height: 500px;
}

footer {
  max-width: 980px;
  height: 1000px;
  margin: auto;
  border: 1px solid black;
  text-align: center;
}

.fixed{
  position: fixed;
  top: 0px;
}

.aside-box {
  width: 200px;
  height: 80px;
  border: 1px solid black;
  margin: auto;
  margin-top: 10px;
}

@media screen and (max-width: 1000px) {
  main {
    width: 100%;
  }
  .right-bar {
    position: static;
    width: 100%;
    height: 300px;
  }
}


]</marquee>

<h3>JavaScript</h3>
<marquee>[const _window   = window
const _main     = document.querySelector('main')
const _rightBar = document.querySelector('.right-bar')
const HALFWAY_POINT_WIDTH = 1000 // CSSのメティアクエリのmax-width値を設定

// サイドバーのposition:left値を更新する関数
// 画面サイズが変わるたびにleft値を変更する
const updateLeftValOfSidebar = () => {
  const rangeUpToMainRight = _main.getBoundingClientRect().right
  // サイドバーはmainの右隣にあるため、ブラウザの左端からmainの右までの距離を調べる
  _rightBar.style.left = `${rangeUpToMainRight}px`
}

const fixSidebarWhenScrolled = () => {
  const rangeFromTopToHeader = document.querySelector('header')
    .getBoundingClientRect().bottom + _window.pageYOffset

  const rangeFromTopToFooter = document.querySelector('footer')
    .getBoundingClientRect().top + _window.pageYOffset - _rightBar.clientHeight
  // メインコンテンツより下(フッター内)の場合のtopの値を計算
  // right-barの位置をスクロール量を合わせて固定表示にする
  const sidebarTopFixedVal = `${_main.getBoundingClientRect().bottom +
    _window.pageYOffset - _rightBar.clientHeight}px`
  // スクロール量を取得
  const _windowScrollWeight = _window.pageYOffset
  // サイドバーがメインコンテンツ内にある場合
  if (_windowScrollWeight > rangeFromTopToHeader &&
    _windowScrollWeight < rangeFromTopToFooter) {
    _rightBar.style.top = `0px`
    _rightBar.classList.add('fixed')
  } else {
    _rightBar.style.top = `${rangeFromTopToHeader + 1}px` // borderの1pxを追加
    _rightBar.classList.remove('fixed')
    // メインコンテンツ外かつ、メインコンテンツより下(フッター内)の場合、固定を解除してその場の高さを設定
    if (_windowScrollWeight >= rangeFromTopToFooter) {
      _rightBar.style.top = sidebarTopFixedVal
    }
  }
}

const windowSizeJudge = () => {
  // CSSのメディアクエリでブラウザ幅が997px以下の場合はサイドバーを下に回り込ませているため、
  // サイドバーが横にある場合のみ固定&解除の処理をする
  if (matchMedia(`(min-width: ${HALFWAY_POINT_WIDTH}px)`).matches) {
    fixSidebarWhenScrolled()
    updateLeftValOfSidebar()
    _window.addEventListener('scroll', fixSidebarWhenScrolled)
    _window.addEventListener('resize', updateLeftValOfSidebar)
  } else {
    _window.removeEventListener('scroll', fixSidebarWhenScrolled)
    _window.removeEventListener('resize', updateLeftValOfSidebar)
  }
}

windowSizeJudge()
_window.addEventListener('resize', windowSizeJudge)
]</marquee>

<h2 id="-">解説</h2>
<p>コード内にも説明が書いてありますが、それぞれの関数を順を追って少し解説してみたいと思います。</p>
<h3 id="-windowsizejudge">・windowSizeJudge</h3>
<p>今回のHTMLの構成が一応レスポンシブになるよう考えたので、サイドバーが表示されないくらいのブラウザサイズであれば、サイドバーをメインコンテンツの下にまわり込ませるようCSS側で制御しています。</p>
<p>なのでまず、一番最初に現在のブラウザサイズを取得し、それがCSSで設定した回り込む値(HALFWAY_POINT_WIDTH)より大きいかどうかをmatchMediaメソッドで判定し、</p>
<ul>
<li>大きければサイドバーの固定・解除処理を実行&amp;それぞれイベントリスナーに登録</li>
<li>小さければイベントリスナーを解除</li>
</ul>
<p>という処理をします。</p>
<p>この関数はブラウザサイズが変わるたびに毎回実行しなけば行けないため、addEventListenerでイベントリスナに登録します。(ブラウザサイズ変更のイベント種類名はresize)</p>
<h3 id="-fixsidebarwhenscrolled">・fixSidebarWhenScrolled</h3>
<p>今回のメインであるスクロール時にサイドバーを固定&amp;解除する処理を行います。<br>この関数はwindowSizeJudgeでscrollを検知したら毎回実行されるよう登録してあります。</p>
<p>まず固定する方法として、CSS側にスクロールされても固定となるposition:fixedをクラスとして用意しておき、それを固定するタイミングになったらサイドバーにそのクラスを追加します。</p>
<p>対応するCSSのクラス</p>
<marquee>[.fixed {<br>
  position: fixed;
  top: 0px;
}]
</marquee>

<p>固定するかどうかの判定としては、window.pageYOffsetでスクロール量を取得し、その量がメインコンテンツの高さまで来たら固定、そしてフッターの高さまで来たら解除、という流れでやります。</p>
<p>まず必要な情報としてブラウザの一番上からヘッダーまでの距離、ブラウザの一番上からfooterまでの距離をそれぞれ取得します。この値はスクロールされた状態でリロードするとスクロールされている分値がズレてしまうので、スクロール量も値に足しています。<br>これを変数rangeFromTopToHeaderと変数rangeFromTopToFooterで取得します。</p>
<p>ただし、変数rangeFromTopToFooterはそのままの値を使うと(サンプル)[]のようになってしまうため、サイドバーの高さを引いて調節します。</p>
<p>さらにサイドバーの要素がfooterの位置まで来た場合、そこで固定を解除したらこのままだとサイドバーが一番上まで飛んでいってしまうので、固定を解除したタイミングの位置を変数sidebarTopFixedValで取得しておき、それをCSSのtopとして代入します。</p>
<p>具体的にはmainの下部までの距離を取得、そこにサイドバーの高さを引く事によって以下の画像の高さが取得できます。</p>
<p>()[]</p>
<p>この画像のラインで固定を解除し、その部分の高さをCSSにセットします。</p>
<h3 id="-updateleftvalofsidebar">・updateLeftValOfSidebar</h3>
<p>これもwindowSizeJudgeでresizeされた場合のイベントリスナに登録してありますが、サイドバーはpositionで指定しているため、ブラウザサイズが変わった場合にこの関数でleft値を更新する処理をしています。</p>
<h3 id="-">まとめ</h3>
<p>けっこう複雑だったので、解説もちょっと分かりずらい気がしますが、誰かの参考になってくれたら嬉しいです！<br>外見的には意外と良い感じに作れたので良かったと思っています。</p>
